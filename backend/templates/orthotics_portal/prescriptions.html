{% extends 'orthotics_portal/base.html' %} {% load static %} {# Include all
required modals #} {% include 'orthotics_portal/plantar_modifiers.html' %} {%
include 'orthotics_portal/posting.html' %} {% block title %} Prescriptions -
Orthotics Prescription Portal {% endblock %} {% block extra_css %}
<link rel="stylesheet" href="{% static 'css/notes_attachments.css' %}" />
{% endblock %} {% block content %}
<div class="container mt-4">
  <div class="row mt-5">
    <div class="col-12">
      <h2>Patient Management</h2>
      <p>Add and manage patients to create prescriptions for them.</p>
    </div>
  </div>
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="input-group">
        <input
          type="text"
          class="form-control"
          placeholder="Search patients..."
          id="patientSearch"
        />
        <button class="btn btn-outline" type="button">
          <i class="bi bi-search"></i>
        </button>
      </div>
    </div>
    <div class="col-md-6 d-flex justify-content-md-end mt-3 mt-md-0">
      <a
        href="{% url 'add_patient' %}"
        class="btn"
        style="background-color: #3a6b6d; color: white"
      >
        <i class="bi bi-person-plus"></i> Add Patient
      </a>
    </div>
  </div>
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead>
                <tr>
                  <th>Patient ID</th>
                  <th>Name</th>
                  <th>Date of Birth</th>
                  <th>Contact</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="patientsTableBody">
                {% for patient in patients %}
                <tr>
                  <td>{{ patient.external_id|default:patient.id }}</td>
                  <td>{{ patient.first_name }} {{ patient.last_name }}</td>
                  <td>{{ patient.date_of_birth|date:"M d, Y" }}</td>
                  <td>{{ patient.email }}</td>
                  <td>
                    <button
                      class="btn btn-sm btn-outline view-patient-btn"
                      data-id="{{ patient.id }}"
                    >
                      <i class="bi bi-eye"></i> View
                    </button>
                    <button
                      class="btn btn-sm btn-outline edit-patient-btn"
                      data-id="{{ patient.id }}"
                    >
                      <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button
                      class="btn btn-sm btn-primary"
                      data-id="{{ patient.id }}"
                      data-first-name="{{ patient.first_name }}"
                      data-last-name="{{patient.last_name}}"
                      data-bs-toggle="modal"
                      data-bs-target="#addPatientModal"
                    >
                      <i class="bi bi-clipboard-plus"></i> Prescribe
                    </button>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="5" class="text-center py-4">
                    No patients found. Add a patient to get started.
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Include the modular add patient template -->
{% include 'orthotics_portal/add_patient.html' %}

<!-- Add after the intrinsicAdjustmentsModal -->

<div id="toast-container" class="position-fixed bottom-0 end-0 p-3"></div>
<!-- Full-screen 3D Preview Modal -->

{% include 'orthotics_portal/plantar_modifiers.html' %} {% include
'orthotics_portal/posting.html' %} {% include
'orthotics_portal/material_selection.html' %} {% include
'orthotics_portal/shoe_fitting.html' %} {% include
'orthotics_portal/device_options.html' %}

<!-- Notes & Attachments Section -->
{% include 'orthotics_portal/notes_attachments.html' %} {% include
'orthotics_portal/scan_upload.html' %} {% endblock %} {% block extra_js %}

<script src="{% static 'js/plantar_modifiers.js' %}"></script>
<script src="{% static 'js/posting.js' %}"></script>
<script src="{% static 'js/material_selection.js' %}"></script>
<script src="{% static 'js/shoe_fitting.js' %}"></script>
<script src="{% static 'js/device_options.js' %}"></script>
<script src="{% static 'js/notes_attachments.js' %}"></script>

<style>
  .scan-preview {
    border: 1px dashed #ccc;
    border-radius: 4px;
    padding: 20px;
    height: 200px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
  }
  .scan-preview img {
    max-height: 100%;
    max-width: 100%;
    object-fit: contain;
  }
</style>
<script type="module">
  import * as THREE from "three";
  import { STLLoader } from "three/examples/jsm/loaders/STLLoader";
  import { VRMLLoader } from "three/examples/jsm/loaders/VRMLLoader";
  import { OrbitControls } from "three/examples/jsm/controls/OrbitControls";

  let camera, scene, renderer, controls;
  let object;

  // Debugging
  console.log("Script loaded successfully");

  document.addEventListener("DOMContentLoaded", function () {
    console.log("DOM fully loaded");
    // Check if ApiService is defined
    if (typeof ApiService === "undefined") {
      console.error(
        "ApiService is not defined! The api_service.js file may not have loaded correctly."
      );
      // Create a simple alert at the top of the page
      const alertDiv = document.createElement("div");
      alertDiv.className = "alert alert-danger m-3";
      alertDiv.innerHTML =
        "<strong>Error:</strong> API Service not loaded. This may affect the functionality of this page. Please check the console for more details.";
      document.body.insertBefore(alertDiv, document.body.firstChild);
    } else {
      console.log("ApiService is defined properlyHiding existing modals");
      initializeApp();
      loadPatientsAndPrescriptions();
    }
  });

  let currentPrescriptionId = null;

  function initializeApp() {
    initSavePatientHandler();
    initSavePrescriptionHandler();
    initViewAndEditButtons();
    initPatientSearch();
    initPrescriptionSearch();
    initScanUpload();
    initClinicalMeasuresForm();
    initIntrinsicAdjustmentsForm();
    initOffLoadingForm();
  }

  // Load patients and prescriptions from API
  async function loadPatientsAndPrescriptions() {
    try {
      // Load patients
      const patientsResponse = await ApiService.patients.getAll();
      console.log(patientsResponse.results[0]);
      displayPatients(patientsResponse.results || []);
      // Load prescriptions
      const prescriptionsResponse = await ApiService.prescriptions.getAll();
      // displayPrescriptions(prescriptionsResponse.results || []);
    } catch (error) {
      console.error("Error loading data:", error);
      showToast("Failed to load data. Please try again later.", "danger");
    }
  }

  // Display patients in the table
  function displayPatients(patients) {
    const patientsTableBody = document.getElementById("patientsTableBody");
    patientsTableBody.innerHTML = "";
    if (!patients || patients.length === 0) {
      patientsTableBody.innerHTML = `
        <tr>
          <td colspan="5" class="text-center py-4">
            No patients found. Add a patient to get started.
          </td>
        </tr>
      `;
      return;
    }
    patients.forEach((patient) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${patient.external_id || patient.id}</td>
        <td>${patient.first_name} ${patient.last_name}</td>
        <td>${formatDate(patient.date_of_birth)}</td>
        <td>${patient.email || patient.phone || "N/A"}</td>
        <td>
          <button class="btn btn-sm btn-outline view-patient-btn" data-id="${
            patient.id
          }">
            <i class="bi bi-eye"></i> View
          </button>
          <button
            class="btn btn-sm btn-outline edit-patient-btn"
            data-id="${patient.id}">
            <i class="bi bi-pencil"></i> Edit
          </button>
          <button
            class="btn btn-sm btn-primary" 
            data-id="${patient.id}" 
            data-first-name="${patient.first_name}" 
            data-last-name="${patient.last_name}" 
            data-bs-toggle="modal"
            data-bs-target="#addPatientModal"
            >
            <i class="bi bi-clipboard-plus"></i> Prescribe
          </button>
        </td>
      `;
      patientsTableBody.appendChild(row);
    });
    // Re-initialize buttons after populating the table
    initViewAndEditButtons();
  }

  // Display prescriptions in the table
  function displayPrescriptions(prescriptions) {
    const prescriptionsTableBody = document.getElementById(
      "prescriptionsTableBody"
    );
    prescriptionsTableBody.innerHTML = "";
    if (!prescriptions || prescriptions.length === 0) {
      prescriptionsTableBody.innerHTML = `
        <tr>
          <td colspan="5" class="text-center py-4">
            No prescriptions found. Create a new prescription to get started.
          </td>
        </tr>
      `;
      return;
    }
    prescriptions.forEach((prescription) => {
      // Add row to the table
      const newRow = document.createElement("tr");
      // Determine status badge class
      let statusClass = "";
      switch (prescription.status) {
        case "Pending":
          statusClass = "bg-warning";
          break;
        case "Approved":
          statusClass = "bg-success";
          break;
        case "Completed":
          statusClass = "bg-info";
          break;
        case "Cancelled":
          statusClass = "bg-danger";
          break;
        default:
          statusClass = "bg-secondary";
      }
      newRow.innerHTML = `
        <td>${prescription.id}</td>
        <td>${prescription.patient_name}</td>
        <td>${formatDate(prescription.created_at)}</td>
        <td>
          <span class="badge ${statusClass}">${prescription.status}</span>
        </td>
        <td>
          <button type="button" class="btn btn-sm btn-primary me-1 view-prescription-btn" data-id="${
            prescription.id
          }">
            <i class="bi bi-eye"></i>
          </button>
          <button type="button" class="btn btn-sm btn-secondary me-1 edit-prescription-btn" data-id="${
            prescription.id
          }">
            <i class="bi bi-pencil"></i>
          </button>
          <button type="button" class="btn btn-sm btn-success me-1 add-to-basket-btn" data-id="${
            prescription.id
          }">
            <i class="bi bi-cart-plus"></i>
          </button>
          <button type="button" class="btn btn-sm btn-info me-1 upload-scan-btn" data-id="${
            prescription.id
          }" title="Upload Foot Scans">
            <i class="bi bi-file-earmark-image"></i>
          </button>
          <button type="button" class="btn btn-sm btn-warning clinical-measures-btn" data-id="${
            prescription.id
          }" title="Clinical Measures">
            <i class="bi bi-ruler"></i>
          </button>
        </td>
      `;
      prescriptionsTableBody.appendChild(newRow);
    });
    // Re-initialize buttons after populating the table
    initViewAndEditButtons();
  }

  function initPatientSearch() {
    const searchInput = document.getElementById("patientSearch");
    if (searchInput) {
      searchInput.addEventListener("input", function () {
        const searchTerm = this.value.toLowerCase();
        searchPatients(searchTerm);
      });
    }
  }

  async function searchPatients(searchTerm) {
    if (!searchTerm) {
      // If search term is empty, reload all patients
      const response = await ApiService.patients.getAll();
      displayPatients(response.results || []);
      return;
    }
    // Otherwise filter the patients table client-side
    const rows = document.querySelectorAll("#patientsTableBody tr");
    rows.forEach((row) => {
      const text = row.textContent.toLowerCase();
      if (text.includes(searchTerm)) {
        row.style.display = "";
      } else {
        row.style.display = "none";
      }
    });
  }

  function initPrescriptionSearch() {
    const searchInput = document.getElementById("prescriptionSearch");
    if (searchInput) {
      searchInput.addEventListener("input", function () {
        const searchTerm = this.value.toLowerCase();
        searchPrescriptions(searchTerm);
      });
    }
  }

  async function searchPrescriptions(searchTerm) {
    if (!searchTerm) {
      // If search term is empty, reload all prescriptions
      const response = await ApiService.prescriptions.getAll();
      displayPrescriptions(response.results || []);
      return;
    }
    // Otherwise filter the prescriptions table client-side
    const rows = document.querySelectorAll("#prescriptionsTableBody tr");
    rows.forEach((row) => {
      const text = row.textContent.toLowerCase();
      if (text.includes(searchTerm)) {
        row.style.display = "";
      } else {
        row.style.display = "none";
      }
    });
  }
  async function updatePrescriptionPatientSelect(newPatientId, fullName) {
    const select = document.getElementById("prescriptionPatient");
    if (!select) return;

    // Check if patient already exists (prevent duplicates)
    let existingOption = select.querySelector(
      `option[value="${newPatientId}"]`
    );

    if (!existingOption) {
      const option = document.createElement("option");
      option.value = newPatientId;
      option.textContent = fullName;
      select.appendChild(option);
    }

    // Select the new patient
    select.value = newPatientId;
  }

  function initPatientForm() {
    const savePatientBtn = document.getElementById("savePatientBtn");
    if (!savePatientBtn) return;

    savePatientBtn.addEventListener("click", async function () {
      const form = document.getElementById("addPatientForm");
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const formData = {
        first_name: document.getElementById("firstName").value,
        last_name: document.getElementById("lastName").value,
        date_of_birth: document.getElementById("dateOfBirth").value,
        gender: document.getElementById("gender").value,
        external_id: document.getElementById("patientId").value,
      };

      savePatientBtn.disabled = true;
      savePatientBtn.innerHTML =
        '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';

      try {
        const response = await ApiService.patients.create(formData);
        console.log("post patients response", response);
        showToast("Patient added successfully", "success");

        // Hide and reset the add patient modal
        const modal = bootstrap.Modal.getInstance(
          document.getElementById("addPatientModal")
        );
        modal.hide();
        form.reset();

        // Get the prescription ID from the response
        const prescriptionId = response.prescription_id;

        // Show the scan upload modal with the prescription ID
        if (prescriptionId) {
          openScanUploadModal(prescriptionId);
        } else {
          console.error("No prescription ID returned");
          showToast(
            "Patient created but couldn't get prescription ID. Please try uploading scans later.",
            "warning"
          );
        }

        // Reload the patients and prescriptions list
        await loadPatientsAndPrescriptions();
      } catch (error) {
        console.error("Error creating patient:", error);
        showToast(
          "Failed to add patient: " + (error.message || "Unknown error"),
          "danger"
        );
      } finally {
        savePatientBtn.disabled = false;
        savePatientBtn.innerHTML = "Save Patient";
      }
    });
  }

  function initSavePatientHandler() {
    const addPatientModal = document.getElementById("addPatientModal");
    if (addPatientModal) {
      addPatientModal.addEventListener("show.bs.modal", function (event) {
        // Clear the form when the modal is shown
        const form = document.getElementById("addPatientForm");
        if (form) {
          form.reset();
        }
      });
    }
    initPatientForm();
  }

  function initPrescriptionForm() {
    const savePrescriptionBtn = document.getElementById("savePrescriptionBtn");
    if (savePrescriptionBtn) {
      savePrescriptionBtn.addEventListener("click", async function () {
        // Validate form
        const form = document.getElementById("createPrescriptionForm");
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }
        const user = JSON.parse(localStorage.getItem("user_info"));
        const clinician_id = user.id;
        // Get form data
        const formData = {
          patient: document.getElementById("prescriptionPatient").value,
          orthotic_type: document.getElementById("orthoticType").value,
          activity_level: document.getElementById("activityLevel").value,
          arch_support: document.getElementById("archSupport").value,
          cushioning: document.getElementById("cushioning").value,
          additional_notes:
            document.getElementById("additionalNotes").value || null,
          clinician: clinician_id,
        };
        // Show loading state
        savePrescriptionBtn.disabled = true;
        savePrescriptionBtn.innerHTML =
          '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Creating...';
        try {
          // Use the API service to create a prescription
          console.log(formData);
          console.log("Creating prescription...");
          const response = await ApiService.prescriptions.create(formData);
          console.log("Prescription created:", response);

          // Store the prescription ID
          const prescriptionId = response.id;

          // Show success message
          showToast("Prescription created successfully", "success");

          // Close the modal
          const modal = bootstrap.Modal.getInstance(
            document.getElementById("createPrescriptionModal")
          );
          modal.hide();

          // Reload prescriptions
          await loadPatientsAndPrescriptions();

          // Reset the form
          form.reset();

          // Open the scan upload modal with the new prescription ID
          if (prescriptionId) {
            openScanUploadModal(prescriptionId);
          } else {
            console.error("No prescription ID returned from creation");
            showToast(
              "Created prescription but couldn't get ID. Please try uploading scans later.",
              "warning"
            );
          }
        } catch (error) {
          console.error("Error creating prescription:", error);
          showToast(
            "Failed to create prescription: " +
              (error.message || "Unknown error"),
            "danger"
          );
        } finally {
          // Re-enable the button
          savePrescriptionBtn.disabled = false;
          savePrescriptionBtn.innerHTML = "Create Prescription";
        }
      });
    }
  }

  function initSavePrescriptionHandler() {
    const createPrescriptionModal = document.getElementById(
      "createPrescriptionModal"
    );
    if (createPrescriptionModal) {
      createPrescriptionModal.addEventListener(
        "show.bs.modal",
        function (event) {
          // Optionally, you could load patient data into the select field here if needed
        }
      );
    }
    initPrescriptionForm();
  }

  function initViewAndEditButtons() {
    const patientTableBody = document.getElementById("patientsTableBody");
    if (patientTableBody) {
      patientTableBody.addEventListener("click", function (event) {
        const target = event.target.closest("button");
        if (!target) return;

        if (target.classList.contains("create-prescription-btn")) {
          const patientId = target.dataset.id;
          if (patientId) {
            openScanUploadModal(patientId);
          }
        } else if (target.classList.contains("view-patient-btn")) {
          const patientId = target.dataset.id;
          console.log("View patient:", patientId);
          // Implement view patient functionality
        } else if (target.classList.contains("edit-patient-btn")) {
          const patientId = target.dataset.id;
          console.log("Edit patient:", patientId);
          // Implement edit patient functionality
        }
      });
    }

    const prescriptionTableBody = document.getElementById(
      "prescriptionsTableBody"
    );
    if (prescriptionTableBody) {
      prescriptionTableBody.addEventListener("click", function (event) {
        if (event.target.classList.contains("view-prescription-btn")) {
          const prescriptionId = event.target.dataset.id;
          console.log("View prescription:", prescriptionId);
          // Implement view prescription functionality
        } else if (event.target.classList.contains("edit-prescription-btn")) {
          const prescriptionId = event.target.dataset.id;
          console.log("Edit prescription:", prescriptionId);
          // Implement edit prescription functionality
        } else if (event.target.classList.contains("add-to-basket-btn")) {
          const prescriptionId = event.target.dataset.id;
          console.log("Add to basket:", prescriptionId);
          // Implement add to basket functionality
        } else if (event.target.classList.contains("upload-scan-btn")) {
          const prescriptionId = event.target.dataset.id;
          // Call the globally exposed function to open the scan upload modal
          window.openScanUploadModal(prescriptionId);
        } else if (event.target.classList.contains("clinical-measures-btn")) {
          const prescriptionId = event.target.dataset.id;
          // Open the clinical measures modal
          openClinicalMeasuresModal(prescriptionId);
        }
      });
    }
  }

  function formatDate(dateString) {
    if (!dateString) return "N/A";
    const date = new Date(dateString);
    const options = { year: "numeric", month: "short", day: "numeric" };
    return date.toLocaleDateString(undefined, options);
  }

  function showToast(message, type = "success") {
    const toastContainer = document.getElementById("toast-container");
    if (toastContainer) {
      const toast = document.createElement("div");
      toast.classList.add(
        "toast",
        "align-items-center",
        "text-white",
        `bg-${type}`,
        "border-0"
      );
      toast.setAttribute("role", "alert");
      toast.setAttribute("aria-live", "assertive");
      toast.setAttribute("aria-atomic", "true");
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      `;
      toastContainer.appendChild(toast);
      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();
    }
  }

  // Handle the clinical measures form
  function initClinicalMeasuresForm() {
    const saveClinicalMeasuresBtn = document.getElementById(
      "saveClinicalMeasuresBtn"
    );

    // Initialize increment/decrement buttons
    initAlignmentControls();

    if (saveClinicalMeasuresBtn) {
      saveClinicalMeasuresBtn.addEventListener("click", async function () {
        // Get the prescription ID
        const prescriptionId = document.getElementById(
          "clinicalMeasuresPrescriptionId"
        ).value;
        if (!prescriptionId) {
          showToast("No prescription selected", "danger");
          return;
        }

        // Collect all form data
        const formData = {
          prescription: prescriptionId,
          left_scan_angle: document.getElementById("leftScanAngle").value || 0,
          left_forefoot_varus:
            document.getElementById("leftForefootVarus").value || 0,
          left_forefoot_valgus:
            document.getElementById("leftForefootValgus").value || 0,
          left_heel_to_mpj_centre:
            document.getElementById("leftHeelToMPJ").value || 0,
          left_posterior_heel_to_heel_centre:
            document.getElementById("leftPosteriorHeel").value || 0,
          right_scan_angle:
            document.getElementById("rightScanAngle").value || 0,
          right_forefoot_varus:
            document.getElementById("rightForefootVarus").value || 0,
          right_forefoot_valgus:
            document.getElementById("rightForefootValgus").value || 0,
          right_heel_to_mpj_centre:
            document.getElementById("rightHeelToMPJ").value || 0,
          right_posterior_heel_to_heel_centre:
            document.getElementById("rightPosteriorHeel").value || 0,
        };

        // Show loading state
        saveClinicalMeasuresBtn.disabled = true;
        saveClinicalMeasuresBtn.innerHTML =
          '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';

        try {
          // Save the clinical measures using the API service
          const response = await ApiService.prescriptions
            .saveClinicalMeasures(prescriptionId, formData)
            .then((response) => {
              console.log("Clinical measures saved:", response);
              showToast("Clinical measures saved successfully", "success");
              // reset the clinical measure form
              document.getElementById("clinicalMeasuresForm").reset();
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("clinicalMeasuresModal")
              );
              if (modal) {
                modal.hide();
              }

              // Open the intrinsic adjustments modal with the same prescription ID
              openIntrinsicAdjustmentsModal(prescriptionId);
            });
        } catch (error) {
          console.error("Error saving clinical measures:", error);
          showToast(
            "Failed to save clinical measures: " +
              (error.message || "Unknown error"),
            "danger"
          );
        } finally {
          // Re-enable the button
          saveClinicalMeasuresBtn.disabled = false;
          saveClinicalMeasuresBtn.innerHTML = "Save Measures";
        }
      });
    }
  }

  function initAlignmentControls() {
    // Get all increment and decrement buttons
    const decreaseBtns = document.querySelectorAll(".decrease-btn");
    const increaseBtns = document.querySelectorAll(".increase-btn");

    // Add event listeners for decrement buttons
    decreaseBtns.forEach((btn) => {
      btn.addEventListener("click", function () {
        const targetId = this.getAttribute("data-target");
        const input = document.getElementById(targetId);
        if (input) {
          let value = parseInt(input.value) || 0;
          input.value = Math.max(value - 1, -180); // Prevent going below -180 degrees
        }
      });
    });

    // Add event listeners for increment buttons
    increaseBtns.forEach((btn) => {
      btn.addEventListener("click", function () {
        const targetId = this.getAttribute("data-target");
        const input = document.getElementById(targetId);
        if (input) {
          let value = parseInt(input.value) || 0;
          input.value = Math.min(value + 1, 180); // Prevent going above 180 degrees
        }
      });
    });
  }

  async function loadExistingClinicalMeasures(prescriptionId) {
    try {
      // Fetch existing clinical measures from the API
      const response = await ApiService.prescriptions.getClinicalMeasures(
        prescriptionId
      );
      console.log("Loaded clinical measures:", response);

      if (response) {
        // Populate the form with the retrieved data
        document.getElementById("weight").value = response.weight || "";
        document.getElementById("height").value = response.height || "";

        // Left foot measurements
        if (response.left_foot) {
          document.getElementById("leftFootLength").value =
            response.left_foot.length || "";
          document.getElementById("leftFootWidth").value =
            response.left_foot.width || "";
          document.getElementById("leftArchHeight").value =
            response.left_foot.arch_height || "";

          // Set alignment measurements for left foot
          document.getElementById("leftScanAngle").value =
            response.left_foot.scan_angle || 0;
          document.getElementById("leftForefootVarus").value =
            response.left_foot.forefoot_varus || 0;
          document.getElementById("leftForefootValgus").value =
            response.left_foot.forefoot_valgus || 0;
          document.getElementById("leftHeelToMPJ").value =
            response.left_foot.heel_to_mpj || 0;
          document.getElementById("leftPosteriorHeel").value =
            response.left_foot.posterior_heel || 0;
        }

        // Right foot measurements
        if (response.right_foot) {
          document.getElementById("rightFootLength").value =
            response.right_foot.length || "";
          document.getElementById("rightFootWidth").value =
            response.right_foot.width || "";
          document.getElementById("rightArchHeight").value =
            response.right_foot.arch_height || "";

          // Set alignment measurements for right foot
          document.getElementById("rightScanAngle").value =
            response.right_foot.scan_angle || 0;
          document.getElementById("rightForefootVarus").value =
            response.right_foot.forefoot_varus || 0;
          document.getElementById("rightForefootValgus").value =
            response.right_foot.forefoot_valgus || 0;
          document.getElementById("rightHeelToMPJ").value =
            response.right_foot.heel_to_mpj || 0;
          document.getElementById("rightPosteriorHeel").value =
            response.right_foot.posterior_heel || 0;
        }

        // Gait analysis
        if (response.gait_type) {
          setSelectValue("gaitType", response.gait_type);
        }

        if (response.weight_distribution) {
          setSelectValue("weightDistribution", response.weight_distribution);
        }

        // Clinical observations
        if (response.pressure_points && response.pressure_points.length > 0) {
          setMultiSelectValues("footPressurePoints", response.pressure_points);
        }

        if (response.foot_conditions && response.foot_conditions.length > 0) {
          setMultiSelectValues("footConditions", response.foot_conditions);
        }

        // Notes
        document.getElementById("clinicalNotes").value =
          response.clinical_notes || "";
      }
    } catch (error) {
      console.error("Error loading clinical measures:", error);
      // Don't show a toast here as it might be the first time the user is accessing clinical measures
    }
  }

  function setSelectValue(selectId, value) {
    const select = document.getElementById(selectId);
    for (let i = 0; i < select.options.length; i++) {
      if (select.options[i].value === value) {
        select.selectedIndex = i;
        break;
      }
    }
  }

  function setMultiSelectValues(selectId, values) {
    const select = document.getElementById(selectId);
    for (let i = 0; i < select.options.length; i++) {
      select.options[i].selected = values.includes(select.options[i].value);
    }
  }

  function getMultiSelectValues(selectId) {
    const select = document.getElementById(selectId);
    return Array.from(select.selectedOptions).map((option) => option.value);
  }

  function openClinicalMeasuresModal(prescriptionId) {
    // Set the prescription ID
    document.getElementById("clinicalMeasuresPrescriptionId").value =
      prescriptionId;

    // Clear form fields
    document.getElementById("clinicalMeasuresForm").reset();

    // Load existing clinical measures
    loadExistingClinicalMeasures(prescriptionId);

    // Show the modal
    const modal = new bootstrap.Modal(
      document.getElementById("clinicalMeasuresModal")
    );
    modal.show();
  }

  // Add after the initClinicalMeasuresForm function
  function initIntrinsicAdjustmentsForm() {
    const saveIntrinsicAdjustmentsBtn = document.getElementById(
      "saveIntrinsicAdjustmentsBtn"
    );

    // Initialize the "Next" button in the clinical measures modal to open the intrinsic adjustments modal
    const nextStepBtnIntrinsicAdjustments = document.getElementById(
      "nextStepBtnIntrinsicAdjustments"
    );
    if (nextStepBtnIntrinsicAdjustments) {
      nextStepBtnIntrinsicAdjustments.addEventListener("click", function () {
        // First close the clinical measures modal
        const clinicalMeasuresModal = bootstrap.Modal.getInstance(
          document.getElementById("clinicalMeasuresModal")
        );
        if (clinicalMeasuresModal) {
          clinicalMeasuresModal.hide();
        }

        // Get the prescription ID from the clinical measures form
        const prescriptionId = document.getElementById(
          "clinicalMeasuresPrescriptionId"
        ).value;

        const intrinsicAdjustmentsModal = new bootstrap.Modal(
          document.getElementById("intrinsicAdjustmentsModal")
        );
        if (intrinsicAdjustmentsModal) {
          document.getElementById("intrinsicAdjustmentsPrescriptionId").value =
            prescriptionId;
          // Clear form fields
          document.getElementById("intrinsicAdjustmentsForm").reset();
          // Load existing intrinsic adjustments
          loadExistingIntrinsicAdjustments(prescriptionId);
          intrinsicAdjustmentsModal.show();
        }
      });
    }

    // Initialize increment/decrement buttons for numeric fields
    initIntrinsicAdjustmentControls();

    if (saveIntrinsicAdjustmentsBtn) {
      saveIntrinsicAdjustmentsBtn.addEventListener("click", async function () {
        // Get the prescription ID
        const prescriptionId = document.getElementById(
          "intrinsicAdjustmentsPrescriptionId"
        ).value;
        if (!prescriptionId) {
          showToast("No prescription selected", "danger");
          return;
        }

        // Show loading state
        saveIntrinsicAdjustmentsBtn.disabled = true;
        saveIntrinsicAdjustmentsBtn.innerHTML =
          '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';

        try {
          // Collect all form data
          const formData = {
            prescription: prescriptionId,
            left_foot: {
              arch_expansion:
                document.getElementById("leftArchExpansion").value || "none",
              heel_expansion:
                document.getElementById("leftHeelExpansion").value || "none",
              shell_width:
                document.getElementById("leftShellWidth").value || "standard",
              shell_length:
                document.getElementById("leftShellLength").value || "standard",
              pfa_height: {
                type:
                  document.getElementById("leftPFAHeight").value || "straight",
                value:
                  parseFloat(
                    document.getElementById("leftPFAHeightValue").value
                  ) || 0,
              },
              skive: {
                type: document.getElementById("leftSkive").value || "medial",
                method:
                  document.getElementById("leftSkiveMethod").value ||
                  "depth/degree",
                depth:
                  parseFloat(document.getElementById("leftSkiveDepth").value) ||
                  0,
                degrees:
                  parseFloat(
                    document.getElementById("leftSkiveDegrees").value
                  ) || 0,
                inclination:
                  document.getElementById("leftSkiveInclination").value ||
                  "maximum",
              },
            },
            right_foot: {
              arch_expansion:
                document.getElementById("rightArchExpansion").value || "none",
              heel_expansion:
                document.getElementById("rightHeelExpansion").value || "none",
              shell_width:
                document.getElementById("rightShellWidth").value || "standard",
              shell_length:
                document.getElementById("rightShellLength").value || "standard",
              pfa_height: {
                type:
                  document.getElementById("rightPFAHeight").value || "straight",
                value:
                  parseFloat(
                    document.getElementById("rightPFAHeightValue").value
                  ) || 0,
              },
              skive: {
                type: document.getElementById("rightSkive").value || "medial",
                method:
                  document.getElementById("rightSkiveMethod").value ||
                  "depth/degree",
                depth:
                  parseFloat(
                    document.getElementById("rightSkiveDepth").value
                  ) || 0,
                degrees:
                  parseFloat(
                    document.getElementById("rightSkiveDegrees").value
                  ) || 0,
                inclination:
                  document.getElementById("rightSkiveInclination").value ||
                  "maximum",
              },
            },
          };

          // Save the intrinsic adjustments
          const response =
            await ApiService.prescriptions.saveIntrinsicAdjustments(
              prescriptionId,
              formData
            );
          console.log("Intrinsic adjustments saved:", response);
          showToast("Intrinsic adjustments saved successfully", "success");

          // Get the modal instance
          const modal = bootstrap.Modal.getInstance(
            document.getElementById("intrinsicAdjustmentsModal")
          );
          if (modal) {
            modal.hide();
          }

          // Open the off-loading modal
          openOffLoadingModal(prescriptionId);
        } catch (error) {
          console.error("Error saving intrinsic adjustments:", error);
          showToast(
            "Failed to save intrinsic adjustments: " +
              (error.response?.data?.error || error.message || "Unknown error"),
            "danger"
          );
        } finally {
          // Re-enable the button
          saveIntrinsicAdjustmentsBtn.disabled = false;
          saveIntrinsicAdjustmentsBtn.innerHTML = "Save Adjustments";
        }
      });
    }

    // Handle the Finalize button
    const finalizeBtn = document.getElementById("finalizeBtn");
    if (finalizeBtn) {
      finalizeBtn.addEventListener("click", function () {
        // Save the form first
        saveIntrinsicAdjustmentsBtn.click();

        // We could navigate to a summary page or submit the final prescription here
        setTimeout(() => {
          showToast("Prescription finalized successfully!", "success");
        }, 1000);
      });
    }
  }

  function initIntrinsicAdjustmentControls() {
    // Get all increment and decrement buttons
    const decreaseBtns = document.querySelectorAll(".decrease-btn");
    const increaseBtns = document.querySelectorAll(".increase-btn");

    // Remove existing event listeners first
    decreaseBtns.forEach((btn) => {
      const newBtn = btn.cloneNode(true);
      btn.parentNode.replaceChild(newBtn, btn);
    });

    increaseBtns.forEach((btn) => {
      const newBtn = btn.cloneNode(true);
      btn.parentNode.replaceChild(newBtn, btn);
    });

    // Get the fresh references after cloning
    const freshDecreaseBtns = document.querySelectorAll(".decrease-btn");
    const freshIncreaseBtns = document.querySelectorAll(".increase-btn");

    // Add event listeners for decrement buttons
    freshDecreaseBtns.forEach((btn) => {
      btn.addEventListener("click", function () {
        const targetId = this.getAttribute("data-target");
        const input = document.getElementById(targetId);
        if (input) {
          let value = parseInt(input.value) || 0;
          input.value = Math.max(value - 1, 0); // Prevent negative values
        }
      });
    });

    // Add event listeners for increment buttons
    freshIncreaseBtns.forEach((btn) => {
      btn.addEventListener("click", function () {
        const targetId = this.getAttribute("data-target");
        const input = document.getElementById(targetId);
        if (input) {
          let value = parseInt(input.value) || 0;
          input.value = Math.min(value + 1, 100); // Set a reasonable maximum
        }
      });
    });
  }

  async function loadExistingIntrinsicAdjustments(prescriptionId) {
    try {
      // Here we would fetch existing intrinsic adjustments from the API
      // For now, we'll leave this as a placeholder
      console.log(
        "Loading intrinsic adjustments for prescription:",
        prescriptionId
      );

      // Example of how you might populate the form if you had data:
      /*
      const response = await ApiService.prescriptions.getIntrinsicAdjustments(prescriptionId);
      if (response) {
        // Left foot
        document.getElementById("leftArchExpansion").value = response.left_foot.arch_expansion || 'none';
        document.getElementById("leftHeelExpansion").value = response.left_foot.heel_expansion || 'none';
        document.getElementById("leftShellWidth").value = response.left_foot.shell_width || 'standard';
        document.getElementById("leftShellLength").value = response.left_foot.shell_length || 'standard';
        
        if (response.left_foot.pfa_height) {
          document.getElementById("leftPFAHeight").value = response.left_foot.pfa_height.type || 'straight';
          document.getElementById("leftPFAHeightValue").value = response.left_foot.pfa_height.value || 0;
        }
        
        if (response.left_foot.skive) {
          document.getElementById("leftSkive").value = response.left_foot.skive.type || 'medial';
          document.getElementById("leftSkiveMethod").value = response.left_foot.skive.method || 'depth/degree';
          document.getElementById("leftSkiveDepth").value = response.left_foot.skive.depth || 0;
          document.getElementById("leftSkiveDegrees").value = response.left_foot.skive.degrees || 0;
          document.getElementById("leftSkiveInclination").value = response.left_foot.skive.inclination || 'maximum';
        }
        
        // Right foot
        document.getElementById("rightArchExpansion").value = response.right_foot.arch_expansion || 'none';
        document.getElementById("rightHeelExpansion").value = response.right_foot.heel_expansion || 'none';
        document.getElementById("rightShellWidth").value = response.right_foot.shell_width || 'standard';
        document.getElementById("rightShellLength").value = response.right_foot.shell_length || 'standard';
        
        if (response.right_foot.pfa_height) {
          document.getElementById("rightPFAHeight").value = response.right_foot.pfa_height.type || 'straight';
          document.getElementById("rightPFAHeightValue").value = response.right_foot.pfa_height.value || 0;
        }
        
        if (response.right_foot.skive) {
          document.getElementById("rightSkive").value = response.right_foot.skive.type || 'medial';
          document.getElementById("rightSkiveMethod").value = response.right_foot.skive.method || 'depth/degree';
          document.getElementById("rightSkiveDepth").value = response.right_foot.skive.depth || 0;
          document.getElementById("rightSkiveDegrees").value = response.right_foot.skive.degrees || 0;
          document.getElementById("rightSkiveInclination").value = response.right_foot.skive.inclination || 'maximum';
        }
      }
      */
    } catch (error) {
      console.error("Error loading intrinsic adjustments:", error);
    }
  }

  function openIntrinsicAdjustmentsModal(prescriptionId) {
    // Set the prescription ID
    document.getElementById("intrinsicAdjustmentsPrescriptionId").value =
      prescriptionId;

    // Clear form fields
    document.getElementById("intrinsicAdjustmentsForm").reset();

    // Load existing intrinsic adjustments if available
    loadExistingIntrinsicAdjustments(prescriptionId);

    // Show the modal
    const modal = new bootstrap.Modal(
      document.getElementById("intrinsicAdjustmentsModal")
    );
    modal.show();
  }

  function initOffLoadingForm() {
    const saveOffLoadingBtn = document.getElementById("saveOffLoadingBtn");
    const nextToPlanterModifiersBtn = document.getElementById(
      "nextToPlanterModifiersBtn"
    );

    // Initialize the "Next" button in the intrinsic adjustments modal to open the off-loading modal
    const nextToOffLoadingBtn = document.getElementById("nextToOffLoadingBtn");
    if (nextToOffLoadingBtn) {
      nextToOffLoadingBtn.addEventListener("click", function () {
        // First save the intrinsic adjustments
        document.getElementById("saveIntrinsicAdjustmentsBtn").click();

        // Wait a bit for the save to complete
        setTimeout(() => {
          // Close the intrinsic adjustments modal
          const intrinsicModal = bootstrap.Modal.getInstance(
            document.getElementById("intrinsicAdjustmentsModal")
          );
          if (intrinsicModal) {
            intrinsicModal.hide();
          }

          // Get the prescription ID from the intrinsic adjustments form
          const prescriptionId = document.getElementById(
            "intrinsicAdjustmentsPrescriptionId"
          ).value;
          // Open the off-loading modal with the same prescription ID
          openOffLoadingModal(prescriptionId);
        }, 800);
      });
    }

    // Initialize increment/decrement buttons for numeric fields
    initOffLoadingControls();

    if (saveOffLoadingBtn) {
      saveOffLoadingBtn.addEventListener("click", async function () {
        // Get the prescription ID
        const prescriptionId = document.getElementById(
          "offLoadingPrescriptionId"
        ).value;
        if (!prescriptionId) {
          showToast("No prescription selected", "danger");
          return;
        }

        // Collect all form data
        const formData = {
          prescription: prescriptionId,
          left_foot: {
            cuboid: {
              raise: document.getElementById("leftCuboidRaise").value || 0,
              dell: document.getElementById("leftCuboidDell").value || 0,
            },
            styloid: {
              raise: document.getElementById("leftStyloidRaise").value || 0,
              dell: document.getElementById("leftStyloidDell").value || 0,
            },
            navicular: {
              raise: document.getElementById("leftNavicularRaise").value || 0,
              dell: document.getElementById("leftNavicularDell").value || 0,
            },
            apertures: document.querySelector(
              'input[name="leftApertures"]:checked'
            ).value,
            no_fill: document.getElementById("leftNoFill").checked,
            poron_u_pad: document.getElementById("leftPoronUPad").value,
            eva_u_pad: document.getElementById("leftEVAUPad").value,
            metatarsal_dome:
              document.getElementById("leftMetatarsalDome").value,
            metatarsal_pad:
              document.querySelector('input[name="leftMetatarsalPad"]:checked')
                .value === "yes",
          },
          right_foot: {
            cuboid: {
              raise: document.getElementById("rightCuboidRaise").value || 0,
              dell: document.getElementById("rightCuboidDell").value || 0,
            },
            styloid: {
              raise: document.getElementById("rightStyloidRaise").value || 0,
              dell: document.getElementById("rightStyloidDell").value || 0,
            },
            navicular: {
              raise: document.getElementById("rightNavicularRaise").value || 0,
              dell: document.getElementById("rightNavicularDell").value || 0,
            },
            apertures: document.querySelector(
              'input[name="rightApertures"]:checked'
            ).value,
            no_fill: document.getElementById("rightNoFill").checked,
            poron_u_pad: document.getElementById("rightPoronUPad").value,
            eva_u_pad: document.getElementById("rightEVAUPad").value,
            metatarsal_dome: document.getElementById("rightMetatarsalDome")
              .value,
            metatarsal_pad:
              document.querySelector('input[name="rightMetatarsalPad"]:checked')
                .value === "yes",
          },
        };

        // Show loading state
        saveOffLoadingBtn.disabled = true;
        saveOffLoadingBtn.innerHTML =
          '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';

        try {
          // Save the off-loading using the API service
          // For now, we'll simulate a successful save since the API endpoint might not exist yet
          console.log("Saving off-loading:", formData);

          // let save it to the backend
          const response = await ApiService.prescriptions
            .saveOffLoading(prescriptionId, formData)
            .then((response) => {
              console.log("Off-loading saved:", response);
              showToast("Off-loading saved successfully", "success");

              // Close the modal
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("offLoadingModal")
              );
              if (modal) {
                modal.hide();
              }

              // Open the Plantar Modifiers modal
              console.log("Opening Plantar Modifiers modal");
              document.getElementById("planterModifiersPrescriptionId").value =
                prescriptionId;
              openPlanterModifierModal(prescriptionId);
            });
        } catch (error) {
          console.error("Error saving off-loading:", error);
          showToast(
            "Failed to save off-loading: " + (error.message || "Unknown error"),
            "danger"
          );
        } finally {
          // Re-enable the button
          saveOffLoadingBtn.disabled = false;
          saveOffLoadingBtn.innerHTML = "Save Off-Loading";
        }
      });
    }

    // Handle the Finalize button
    const finalizeOffLoadingBtn = document.getElementById(
      "finalizeOffLoadingBtn"
    );
    if (finalizeOffLoadingBtn) {
      finalizeOffLoadingBtn.addEventListener("click", function () {
        // Save the form first
        saveOffLoadingBtn.click();

        // We could navigate to a summary page or submit the final prescription here
        setTimeout(() => {
          showToast(
            "Prescription finalized and ready for production!",
            "success"
          );
        }, 1000);
      });
    }

    // Handle the Next to Plantar Modifiers button
    if (nextToPlanterModifiersBtn) {
      nextToPlanterModifiersBtn.addEventListener("click", function () {
        // First save the off-loading data
        saveOffLoadingBtn.click();

        // Wait a bit for the save to complete
        setTimeout(() => {
          // Close the off-loading modal
          const offLoadingModal = bootstrap.Modal.getInstance(
            document.getElementById("offLoadingModal")
          );
          if (offLoadingModal) {
            offLoadingModal.hide();
          }

          // Get the prescription ID
          const prescriptionId = document.getElementById(
            "offLoadingPrescriptionId"
          ).value;

          // Open the Plantar Modifiers modal using the module's method
          if (window.PlanterModifiersModule) {
            const planterModal = new bootstrap.Modal(
              document.getElementById("planterModifierModal")
            );
            planterModal.show();
            PlanterModifiersModule.openPlanterModifiersModal(prescriptionId);
          } else {
            console.error("PlanterModifiersModule not found");
            showToast(
              "Error: Could not load Plantar Modifiers module",
              "danger"
            );
          }
        }, 800);
      });
    }
  }

  function initOffLoadingControls() {
    // Get all increment and decrement buttons
    const decreaseBtns = document.querySelectorAll(".decrease-btn");
    const increaseBtns = document.querySelectorAll(".increase-btn");

    // Remove existing event listeners first
    decreaseBtns.forEach((btn) => {
      const newBtn = btn.cloneNode(true);
      btn.parentNode.replaceChild(newBtn, btn);
    });

    increaseBtns.forEach((btn) => {
      const newBtn = btn.cloneNode(true);
      btn.parentNode.replaceChild(newBtn, btn);
    });

    // Get the fresh references after cloning
    const freshDecreaseBtns = document.querySelectorAll(".decrease-btn");
    const freshIncreaseBtns = document.querySelectorAll(".increase-btn");

    // Add event listeners for decrement buttons
    freshDecreaseBtns.forEach((btn) => {
      btn.addEventListener("click", function () {
        const targetId = this.getAttribute("data-target");
        const input = document.getElementById(targetId);
        if (input) {
          let value = parseFloat(input.value) || 0;
          input.value = Math.max(value - 1.5, 0).toFixed(1); // Prevent negative values and maintain decimal precision
        }
      });
    });

    // Add event listeners for increment buttons
    freshIncreaseBtns.forEach((btn) => {
      btn.addEventListener("click", function () {
        const targetId = this.getAttribute("data-target");
        const input = document.getElementById(targetId);
        if (input) {
          let value = parseFloat(input.value) || 0;
          input.value = Math.min(value + 1.5, 100).toFixed(1); // Set a reasonable maximum and maintain decimal precision
        }
      });
    });
  }

  async function loadExistingOffLoading(prescriptionId) {
    try {
      // Here we would fetch existing off-loading from the API
      // For now, we'll leave this as a placeholder
      console.log("Loading off-loading for prescription:", prescriptionId);

      // Example of how you might populate the form if you had data:
      /*
      const response = await ApiService.prescriptions.getOffLoading(prescriptionId);
      if (response) {
        // Left foot
        if (response.left_foot) {
          if (response.left_foot.cuboid) {
            document.getElementById("leftCuboidRaise").value = response.left_foot.cuboid.raise || 0;
            document.getElementById("leftCuboidDell").value = response.left_foot.cuboid.dell || 0;
          }
          
          if (response.left_foot.styloid) {
            document.getElementById("leftStyloidRaise").value = response.left_foot.styloid.raise || 0;
            document.getElementById("leftStyloidDell").value = response.left_foot.styloid.dell || 0;
          }
          
          if (response.left_foot.navicular) {
            document.getElementById("leftNavicularRaise").value = response.left_foot.navicular.raise || 0;
            document.getElementById("leftNavicularDell").value = response.left_foot.navicular.dell || 0;
          }
          
          // Set the apertures radio button
          if (response.left_foot.apertures) {
            const apertureRadio = document.querySelector(`input[name="leftApertures"][value="${response.left_foot.apertures}"]`);
            if (apertureRadio) {
              apertureRadio.checked = true;
            }
          }
          
          // Set the no fill checkbox
          if (response.left_foot.no_fill) {
            document.getElementById("leftNoFill").checked = response.left_foot.no_fill;
          }
          
          // Set the poron u-pad
          if (response.left_foot.poron_u_pad) {
            document.getElementById("leftPoronUPad").value = response.left_foot.poron_u_pad;
          }
          
          // Set the eva u-pad
          if (response.left_foot.eva_u_pad) {
            document.getElementById("leftEVAUPad").value = response.left_foot.eva_u_pad;
          }
          
          // Set the metatarsal dome
          if (response.left_foot.metatarsal_dome) {
            document.getElementById("leftMetatarsalDome").value = response.left_foot.metatarsal_dome;
          }
          
          // Set the metatarsal pad
          if (response.left_foot.metatarsal_pad) {
            document.getElementById("leftMetatarsalPadYes").checked = true;
          } else {
            document.getElementById("leftMetatarsalPadNo").checked = true;
          }
        }
        
        // Right foot (similar to left foot)
        // ...
      }
      */
    } catch (error) {
      console.error("Error loading off-loading:", error);
    }
  }

  function openOffLoadingModal(prescriptionId) {
    // Set the prescription ID
    document.getElementById("offLoadingPrescriptionId").value = prescriptionId;

    // Clear form fields
    document.getElementById("offLoadingForm").reset();

    // Load existing off-loading if available
    loadExistingOffLoading(prescriptionId);

    // Show the modal
    const modal = new bootstrap.Modal(
      document.getElementById("offLoadingModal")
    );
    modal.show();
  }

  function openPlanterModifierModal(prescriptionId) {
    if (!prescriptionId) {
      console.error("No prescription ID provided to openPlanterModifierModal");
      return;
    }

    console.log(
      "Opening Planter Modifier modal for prescription:",
      prescriptionId
    );

    // Show the modal first
    const modal = new bootstrap.Modal(
      document.getElementById("planterModifierModal")
    );
    modal.show();

    // Then initialize the module with the prescription ID
    if (window.PlanterModifiersModule) {
      PlanterModifiersModule.openPlanterModifiersModal(prescriptionId);
    } else {
      console.error("PlanterModifiersModule not found");
      showToast("Error: Could not load Plantar Modifiers module", "danger");
    }
  }

  // Add button click handler in the prescription steps
  function addPlanterModifierButton(prescriptionId) {
    return `
        <button type="button" 
                class="btn btn-primary btn-sm" 
                onclick="openPlanterModifierModal('${prescriptionId}')">
            <i class="fas fa-shoe-prints me-1"></i>
            Plantar Modifiers
        </button>
    `;
  }

  function addMaterialSelectionButton(prescriptionId) {
    return `
        <button type="button" 
                class="btn btn-primary btn-sm" 
                onclick="openMaterialSelectionModal('${prescriptionId}')">
            <i class="fas fa-shoe-prints me-1"></i>
            Material Selection
        </button>
    `;
  }

  function addShoeFittingButton(prescriptionId) {
    return `
        <button type="button" 
                class="btn btn-primary btn-sm" 
                onclick="openShoeFittingModal('${prescriptionId}')">
            <i class="fas fa-shoe-prints me-1"></i>
            Shoe Fitting
        </button>
    `;
  }

  function addPostingButton(prescriptionId) {
    return `
        <button type="button" 
                class="btn btn-primary btn-sm" 
                onclick="openPostingModal('${prescriptionId}')">
            <i class="fas fa-shoe-prints me-1"></i>
            Posting
        </button>
    `;
  }

  function addDeviceOptionsButton(prescriptionId) {
    return `
      <button type="button" 
              class="btn btn-primary btn-sm" 
              onclick="openDeviceOptionsModal('${prescriptionId}')">
          <i class="fas fa-cog me-1"></i>
          Device Options
      </button>
    `;
  }

  function openDeviceOptionsModal(prescriptionId) {
    if (!prescriptionId) {
      console.error("No prescription ID provided");
      return;
    }

    // close any other open modals if needed
    const otherModals = document.querySelectorAll(".modal");
    otherModals.forEach((modal) => {
      const instance = bootstrap.Modal.getInstance(modal);
      if (instance) {
        instance.hide();
      }
    });

    const modal = new bootstrap.Modal(
      document.getElementById("deviceOptionsModal")
    );
    modal.show();

    if (window.deviceOptions) {
      window.deviceOptions.initialize(prescriptionId);
    } else {
      console.error("Device options module not found");
      showToast("error", "Device options module not initialized");
    }
  }

  // Update the renderPrescriptionCard function to include the Plantar Modifiers button
  function renderPrescriptionCard(prescription) {
    return `
        <div class="card mb-3">
            <div class="card-body">
                // ... existing prescription card content ...
                <div class="btn-group" role="group">
                    ${addScanButton(prescription.id)}
                    ${addClinicalMeasuresButton(prescription.id)}
                    ${addOffLoadingButton(prescription.id)}
                    ${addPlanterModifierButton(prescription.id)} 
                    ${addMaterialSelectionButton(prescription.id)}
                    ${addShoeFittingButton(prescription.id)}
                    ${addDeviceOptionsButton(prescription.id)}
                    ${addPostingButton(prescription.id)}
                    
                </div>
            </div>
        </div>
    `;
  }

  function openPostingModal(prescriptionId) {
    console.log("Opening posting modal for prescription:", prescriptionId);
    if (!prescriptionId) {
      showToast("error", "No prescription ID provided");
      return;
    }

    try {
      if (!window.PostingModule) {
        console.error("PostingModule not found");
        showToast("error", "Posting module not initialized");
        return;
      }

      // close the material selection modal
      const materialSelectionModal = bootstrap.Modal.getInstance(
        document.getElementById("materialSelectionModal")
      );
      if (materialSelectionModal) {
        materialSelectionModal.hide();
      }

      const modal = new bootstrap.Modal(
        document.getElementById("postingModal")
      );
      modal.show();

      if (window.PostingModule) {
        window.PostingModule.init(prescriptionId);
      } else {
        console.error("PostingModule not found");
        showToast("error", "Posting module not initialized");
      }
    } catch (error) {
      console.error("Error opening posting modal:", error);
      showToast("error", "Failed to open posting modal");
    }
  }

  function openMaterialSelectionModal(prescriptionId) {
    if (!prescriptionId) {
      console.error(
        "No prescription ID provided for opening material selection modal"
      );
      return;
    }

    try {
      // close posting modal
      const postingModal = bootstrap.Modal.getInstance(
        document.getElementById("postingModal")
      );
      if (postingModal) {
        postingModal.hide();
      }

      const modal = new bootstrap.Modal(
        document.getElementById("materialSelectionModal")
      );
      if (!modal) {
        throw new Error("Material selection modal not found");
      }

      if (!window.MaterialSelectionModule) {
        throw new Error("Material selection module not found");
      }

      // Show the modal
      modal.show();

      if (window.MaterialSelectionModule) {
        window.MaterialSelectionModule.init(prescriptionId);
      } else {
        console.error("Material selection module not found");
        showToast("error", "Material selection module not initialized");
      }
    } catch (error) {
      console.error("Error opening material selection modal:", error);
      showErrorToast("Failed to open material selection modal");
    }
  }

  function openShoeFittingModal(prescriptionId) {
    if (!prescriptionId) {
      console.error("No prescription ID provided");
      return;
    }

    // close the material selection modal
    const materialSelectionModal = bootstrap.Modal.getInstance(
      document.getElementById("materialSelectionModal")
    );
    if (materialSelectionModal) {
      materialSelectionModal.hide();
    }

    if (!window.ShoeFittingModule) {
      console.error("ShoeFittingModule not found");
      return;
    }

    const modal = new bootstrap.Modal(
      document.getElementById("shoeFittingModal")
    );
    modal.show();

    if (window.ShoeFittingModule) {
      window.ShoeFittingModule.init(prescriptionId);
    } else {
      console.error("ShoeFittingModule not found");
      showToast("error", "Shoe fitting module not initialized");
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    // Initialize all modules
    if (prescriptionId) {
      // ... existing module initializations ...
      NotesAttachmentsModule.init(prescriptionId);
    }
  });
</script>
{% endblock %}
