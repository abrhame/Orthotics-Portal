{% extends 'orthotics_portal/base.html' %} {% load static %} {% block title %}
Orders | Orthotics Prescription Portal {% endblock %} {% block extra_css %}
<!-- DataTables CSS -->
<link
  rel="stylesheet"
  type="text/css"
  href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css"
/>
<link
  rel="stylesheet"
  type="text/css"
  href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.dataTables.min.css"
/>
{% endblock %} {% block content %}
<div class="container-fluid">
  <h1 class="h3 mb-2 text-gray-800">Orders</h1>
  <div class="card shadow mb-4">
    <div class="card-body">
      <div class="table-responsive">
        <table id="ordersTable" class="table table-bordered">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Patient</th>
              <th>Prescriptions</th>
              <th>Status</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Order Details Modal -->
  <div
    class="modal fade"
    id="orderDetailsModal"
    tabindex="-1"
    aria-labelledby="orderDetailsModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="orderDetailsModalLabel">Order Details</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <div class="order-info mb-4">
            <div class="row">
              <div class="col-md-12">
                <h5 class="mb-3">Order Details</h5>
                <p>
                  <strong>Order ID:</strong> <span id="modal-order-id"></span>
                </p>
                <p>
                  <strong>Date:</strong> <span id="modal-order-date"></span>
                </p>
                <p>
                  <strong>Status:</strong> <span id="modal-order-status"></span>
                </p>
              </div>
            </div>
          </div>

          <h6 class="fw-bold">Prescriptions</h6>
          <div class="table-responsive">
            <table class="table table-bordered" id="orderItemsTable">
              <thead>
                <tr>
                  <th>Patient</th>
                  <th>Orthotic Type</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="order-items-list">
                <!-- Order items will be loaded here via JavaScript -->
              </tbody>
            </table>
          </div>

          <div id="modal-notes-section" class="mt-4" style="display: none">
            <h6 class="fw-bold">Notes</h6>
            <div class="card">
              <div class="card-body" id="modal-notes"></div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Close
          </button>
          <button
            type="button"
            class="btn btn-danger"
            id="modalCancelOrderBtn"
            style="display: none"
          >
            Cancel Order
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<!-- DataTables JavaScript -->
<script
  type="text/javascript"
  src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"
></script>
<script
  type="text/javascript"
  src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"
></script>

<script>
  $(document).ready(function () {
    let table = $("#ordersTable").DataTable({
      responsive: true,
      processing: true,
      serverSide: false,
      ajax: {
        url: "/api/orders/",
        dataSrc: "data",
      },
      columns: [
        { data: "id" },
        {
          data: "patient_name",
          render: function (data) {
            return data || "N/A";
          },
        },
        {
          data: "prescriptions",
          render: function (data) {
            return data ? data.length : 0;
          },
        },
        {
          data: "status",
          render: function (data) {
            return data
              ? `<span class="badge bg-${data.toLowerCase()}">${data}</span>`
              : '<span class="badge bg-secondary">N/A</span>';
          },
        },
        {
          data: "created_at",
          render: function (data) {
            return data ? new Date(data).toLocaleDateString() : "N/A";
          },
        },
        {
          data: null,
          render: function (data, type, row) {
            let buttons = `<button class="btn btn-sm btn-primary view-order" data-id="${row.id}">View</button>`;
            if (row.status === "pending") {
              buttons += ` <button class="btn btn-sm btn-danger cancel-order" data-id="${row.id}">Cancel</button>`;
            }
            return buttons;
          },
        },
      ],
      order: [[4, "desc"]],
      language: {
        processing: "Loading orders...",
        zeroRecords: "No orders found",
        emptyTable: "No orders available",
      },
    });

    // Function to format date
    function formatDate(dateString) {
      return new Date(dateString).toLocaleDateString("en-US", {
        year: "numeric",
        month: "long",
        day: "numeric",
      });
    }

    // Handle view order button click
    $("#ordersTable").on("click", ".view-order", function () {
      const orderId = $(this).data("id");

      // Show loading state in modal
      $("#modal-order-id").text("Loading...");
      $("#modal-order-date").text("Loading...");
      $("#modal-order-status").text("Loading...");
      $("#order-items-list").html(
        '<tr><td colspan="4" class="text-center">Loading...</td></tr>'
      );

      // Show the modal
      $("#orderDetailsModal").modal("show");

      // Fetch order details
      $.ajax({
        url: `/api/orders/${orderId}/`,
        method: "GET",
        success: function (response) {
          // Update modal with order details
          $("#modal-order-id").text(response.id);
          $("#modal-order-date").text(formatDate(response.created_at));
          $("#modal-order-status").html(
            response.status
              ? `<span class="badge bg-${response.status.toLowerCase()}">${
                  response.status
                }</span>`
              : '<span class="badge bg-secondary">N/A</span>'
          );

          // Clear and populate prescriptions table
          let prescriptionsHtml = "";
          response.prescriptions.forEach(function (prescription) {
            const status = prescription.status || "N/A";
            prescriptionsHtml += `
              <tr>
                <td>${prescription.patient_name || "N/A"}</td>
                <td>${prescription.orthotic_type || "Custom"}</td>
                <td><span class="badge bg-${status.toLowerCase()}">${status}</span></td>
                <td>
                  <a href="/prescriptions/${
                    prescription.id
                  }/" class="btn btn-primary btn-sm" target="_blank">
                    <i class="fas fa-eye me-1"></i> View
                  </a>
                </td>
              </tr>
            `;
          });
          $("#order-items-list").html(
            prescriptionsHtml ||
              '<tr><td colspan="4" class="text-center">No prescriptions found</td></tr>'
          );

          // Handle notes
          if (response.notes) {
            $("#modal-notes").html(response.notes.replace(/\n/g, "<br>"));
            $("#modal-notes-section").show();
          } else {
            $("#modal-notes-section").hide();
          }

          // Show/hide cancel button based on order status
          if (response.status === "pending") {
            $("#modalCancelOrderBtn").show();
            $("#modalCancelOrderBtn").data("order-id", response.id);
          } else {
            $("#modalCancelOrderBtn").hide();
          }
        },
        error: function (xhr) {
          // Handle error
          $("#orderDetailsModal").modal("hide");
          alert(
            "Error loading order details: " +
              (xhr.responseJSON?.error || "Unknown error")
          );
        },
      });
    });

    // Handle cancel order button click (both in table and modal)
    $("#ordersTable, #orderDetailsModal").on(
      "click",
      ".cancel-order, #modalCancelOrderBtn",
      function () {
        const orderId = $(this).data("id") || $(this).data("order-id");
        if (confirm("Are you sure you want to cancel this order?")) {
          $.ajax({
            url: `/api/orders/${orderId}/cancel/`,
            method: "POST",
            headers: {
              "X-CSRFToken": getCookie("csrftoken"),
            },
            success: function () {
              table.ajax.reload();
              $("#orderDetailsModal").modal("hide");
            },
            error: function (xhr) {
              alert(
                "Error cancelling order: " +
                  (xhr.responseJSON?.error || "Unknown error")
              );
            },
          });
        }
      }
    );

    // Helper function to get CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === name + "=") {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  });
</script>
{% endblock %}
